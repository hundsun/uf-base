<?xml version="1.0" encoding="UTF-8"?>
<procedure:Procedure xmlns:procedure="http://www.hundsun.com/ares/studio/procedure/1.0.0" name="AP_DEMOACCT_STOCKREAL_UPDATE" chineseName="AP_演示账户管理_股份交易表字段更新" objectId="3210002" database="ASSETDB" interfaceFlag="" pseudoCode="&#xA;@secu_over_flag_t := @secu_over_flag;&#xA;if (trim(@secu_over_flag_t) is null) then&#xA;@secu_over_flag_t := &lt;CNST_SECUOVER_NO>;&#xA;end if;&#xA;&#xA;[事务处理开始]&#xA;&#xA;begin&#xA;select enable_amount&#xA;into @enable_amount&#xA;from stockreal&#xA;where stock_account = @stock_account&#xA;and stock_code = @stock_code&#xA;and branch_no = @branch_no&#xA;and exchange_type = @exchange_type&#xA;for update;&#xA;exception&#xA;when NO_DATA_FOUND then&#xA;-- 如果发生的业务为新增股份(occur_amount > 0), 则新插入该账户的新记录&#xA;if (@real_action = '0' and @occur_amount > 0) or @real_action = '1' then&#xA;begin&#xA;@position_str := right('00000'||@branch_no,5) || right('0000'||@exchange_type,4) || right('0000000000' || @stock_account, 10) || right('000000' || @stock_code, 6);&#xA;[插入表记录][stockreal][correct_amount=0,enable_amount=0,current_amount=0,frozen_amount=0,unfrozen_amount=0,sum_buy_amount=0,sum_buy_balance=0,sum_sell_amount=0,sum_sell_balance=0,cost_price=0,check_str=xp_chkdata(@branch_no||@exchange_type||@stock_account||@stock_code||0)]&#xA;exception&#xA;when dup_val_on_index then&#xA;null;&#xA;when others then&#xA;[事务内报错返回][ERR_SECU_ADD_STOCKREAL_FAIL][增加股份变动信息表失败][@stock_account,@stock_code,@branch_no,@exchange_type]&#xA;end;&#xA;else&#xA;[事务内业务报错返回][ERR_SECU_STOCKREAL_NOTEXISTS][股份变动信息表记录不存在][@stock_account,@stock_code,@branch_no,@exchange_type]&#xA;end if;&#xA;when others then&#xA;[事务内报错返回][ERR_SECU_QRY_STOCKREAL_FAIL][查询股份变动信息表失败][@stock_account,@stock_code,@branch_no,@exchange_type]&#xA;end;&#xA;&#xA;-- 总可用份额 =  可用份额 + (当前份额差额 + 解冻份额差额 - 冻结份额差额)&#xA;&#xA;if @secu_over_flag_t = &lt;CNST_SECUOVER_YES> then&#xA;begin&#xA;update stockreal&#xA;set current_amount = current_amount + @current_amount,&#xA;uncome_buy_amount = uncome_buy_amount + @uncome_buy_amount,&#xA;uncome_sell_amount = uncome_sell_amount + @uncome_sell_amount,&#xA;frozen_amount = frozen_amount + @frozen_amount,&#xA;unfrozen_amount = unfrozen_amount + @unfrozen_amount,&#xA;correct_amount = correct_amount + @correct_amount,&#xA;sum_buy_amount = sum_buy_amount + @sum_buy_amount,&#xA;sum_buy_balance = sum_buy_balance + @sum_buy_balance,&#xA;sum_sell_amount = sum_sell_amount + @sum_sell_amount,&#xA;sum_sell_balance = sum_sell_balance + @sum_sell_balance,&#xA;cost_price = (case when @cost_price = 0 then cost_price else @cost_price end),&#xA;enable_amount = enable_amount + (@current_amount + @unfrozen_amount - @frozen_amount),&#xA;check_str = xp_chkdata(branch_no||exchange_type||stock_account||stock_code||(enable_amount + @current_amount + @unfrozen_amount - @frozen_amount))&#xA;where stock_account = @stock_account&#xA;and stock_code = @stock_code&#xA;and branch_no = @branch_no&#xA;and exchange_type = @exchange_type&#xA;return enable_amount,current_amount,correct_amount into @post_amount,@current_amount_secu,@correct_amount_secu;&#xA;exception&#xA;when others then&#xA;[事务内报错返回][ERR_SECU_MOD_STOCKREAL_FAIL][修改股份变动信息表失败][@stock_account,@stock_code,@branch_no,@exchange_type]&#xA;end;&#xA;else&#xA;begin&#xA;update stockreal&#xA;set current_amount = current_amount + @current_amount,&#xA;uncome_buy_amount = uncome_buy_amount + @uncome_buy_amount,&#xA;uncome_sell_amount = uncome_sell_amount + @uncome_sell_amount,&#xA;frozen_amount = frozen_amount + @frozen_amount,&#xA;unfrozen_amount = unfrozen_amount + @unfrozen_amount,&#xA;correct_amount = correct_amount + @correct_amount,&#xA;sum_buy_amount = sum_buy_amount + @sum_buy_amount,&#xA;sum_buy_balance = sum_buy_balance + @sum_buy_balance,&#xA;sum_sell_amount = sum_sell_amount + @sum_sell_amount,&#xA;sum_sell_balance = sum_sell_balance + @sum_sell_balance,&#xA;cost_price = (case when @cost_price = 0 then cost_price else @cost_price end),&#xA;enable_amount = enable_amount + (@current_amount + @unfrozen_amount - @frozen_amount),&#xA;check_str = xp_chkdata(branch_no||exchange_type||stock_account||stock_code||(enable_amount + @current_amount + @unfrozen_amount - @frozen_amount))&#xA;where stock_account = @stock_account&#xA;and stock_code = @stock_code&#xA;and branch_no = @branch_no&#xA;and exchange_type = @exchange_type&#xA;and enable_amount + (@current_amount + @unfrozen_amount - @frozen_amount) >= 0&#xA;return enable_amount,current_amount,correct_amount into @post_amount,@current_amount_secu,@correct_amount_secu;&#xA;exception&#xA;[事务内自定义异常返回][ERR_SECU_MOD_STOCKREAL_FAIL][修改股份变动信息表失败][@stock_account,@stock_code,@branch_no,@exchange_type,@secu_over_flag_t]&#xA;end;&#xA;end if;&#xA;&#xA;--可用变动金额&#xA;@occur_amount_t := @current_amount + @unfrozen_amount - @frozen_amount;&#xA;&#xA;-- 只有当影响可用的情况才记录stockrealjour表（从而控制此表的记录数量）&#xA;-- 20090720 zhanggq 增加影响市值的资产数量修正也记录stockrealjour表，主要是为了控制资产数量修正补做业务的并发&#xA;if (@occur_amount_t &lt;> 0.00) or (@correct_amount &lt;> 0.00) then&#xA;-- 20090603 wangxl add 重做情况下先判断原流水是否存在&#xA;if (@redo_flag = '1') then&#xA;begin&#xA;select count(*) into @rowcount from dual&#xA;where exists(select 1 from stockrealjour&#xA;where fund_account = @fund_account&#xA;and business_flag = @business_flag&#xA;and stock_code = @stock_code&#xA;and stock_account = @stock_account&#xA;and cancel_serialno = @cancel_serialno);&#xA;exception&#xA;when others then&#xA;[事务内报错返回][ERR_SECU_QRY_STOCKREALJOUR_FAIL][查询股份冻结明细表失败][@redo_flag,@stock_account,@stock_code,@cancel_serialno]&#xA;end;&#xA;&#xA;if (@rowcount > 0) then&#xA;[事务内业务报错返回][ERR_SECU_STOCKREALJOUR_EXISTS][股份冻结明细表记录已存在][@redo_flag,@stock_account,@stock_code,@cancel_serialno]&#xA;end if;&#xA;end if;&#xA;&#xA;-- 记录股份更新流水&#xA;[AP_演示账户管理_演示账户子系统流水号获取][serial_counter_no = 21, serial_no = @serial_no]&#xA;&#xA;@position_str := right('00000000'||@init_date,8) || right('00000'||@branch_no,5) || right('0000000000' || @serial_no, 10);&#xA;@remark_t := trim(@remark)||'股份交易表字段变动,current_amount='||@current_amount||',uncome_buy_amount='||@uncome_buy_amount||',uncome_sell_amount='||@uncome_sell_amount||',frozen_amount='||@frozen_amount||',unfrozen_amount='||@unfrozen_amount||',correct_amount='||@correct_amount||',sum_buy_amount='||@sum_buy_amount||',sum_buy_balance='||@sum_buy_balance||',sum_sell_amount='||@sum_sell_amount||',sum_sell_balance='||@sum_sell_balance||',cost_price='||@cost_price;&#xA;&#xA;begin&#xA;[插入表记录][stockrealjour][occur_amount = @occur_amount_t,remark=@remark_t]&#xA;exception&#xA;[事务内自定义异常返回][ERR_SECU_ADD_STOCKREALJOUR_FAIL][增加股份冻结明细表失败][@stock_account,@stock_code,@business_flag]&#xA;end;&#xA;&#xA;end if;&#xA;&#xA;-- 20090720 zhanggq 紧急修改，增加@nocommit_flag为空的判断&#xA;-- 此处如果不判断为空，可能导致未提交事务存在（某些调用此AP的函数省略不传，@nocommit_flag为空，空等于任何值，导致未提交）&#xA;if (@nocommit_flag &lt;> '1') or (trim(@nocommit_flag) is null)  then&#xA;[事务处理结束]&#xA;end if;&#xA;&#xA;&#xA;">
  <inputParameters id="op_branch_no" flags="D"/>
  <inputParameters id="operator_no" flags="D"/>
  <inputParameters id="op_station" flags="D"/>
  <inputParameters id="op_entrust_way" flags="D"/>
  <inputParameters id="branch_no" flags="D"/>
  <inputParameters id="secu_over_flag" flags=""/>
  <inputParameters id="stock_account" flags=""/>
  <inputParameters id="stock_code" flags=""/>
  <inputParameters id="exchange_type" flags=""/>
  <inputParameters id="client_id" flags=""/>
  <inputParameters id="fund_account" flags=""/>
  <inputParameters id="occur_amount" flags=""/>
  <inputParameters id="current_amount" flags=""/>
  <inputParameters id="uncome_buy_amount" flags=""/>
  <inputParameters id="uncome_sell_amount" flags=""/>
  <inputParameters id="frozen_amount" flags=""/>
  <inputParameters id="unfrozen_amount" flags=""/>
  <inputParameters id="correct_amount" flags=""/>
  <inputParameters id="sum_buy_amount" flags=""/>
  <inputParameters id="sum_buy_balance" flags=""/>
  <inputParameters id="sum_sell_amount" flags=""/>
  <inputParameters id="sum_sell_balance" flags=""/>
  <inputParameters id="cost_price" flags=""/>
  <inputParameters id="money_type" flags=""/>
  <inputParameters id="stock_type" flags=""/>
  <inputParameters id="init_date" flags=""/>
  <inputParameters id="business_flag" flags=""/>
  <inputParameters id="real_action" flags=""/>
  <inputParameters id="remark" flags=""/>
  <inputParameters id="redo_flag" flags=""/>
  <inputParameters id="cancel_serialno" flags=""/>
  <inputParameters id="nocommit_flag" flags=""/>
  <outputParameters id="error_pathinfo" flags="IO"/>
  <outputParameters id="error_info" flags="D"/>
  <outputParameters id="error_no" flags="D"/>
  <outputParameters id="error_id" flags="D"/>
  <outputParameters id="error_sysinfo" flags="D"/>
  <outputParameters id="current_amount_secu" flags=""/>
  <outputParameters id="correct_amount_secu" flags=""/>
  <outputParameters id="enable_amount" flags=""/>
  <outputParameters id="post_amount" flags=""/>
  <outputParameters id="serial_no" flags=""/>
  <internalVariables id="secu_over_flag_t" name="股份透支标志" paramType="NON_STD_FIELD" type="HsFlag" flags=""/>
</procedure:Procedure>
